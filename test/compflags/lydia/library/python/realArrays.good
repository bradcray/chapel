from libc.stdint cimport *
from chplrt cimport *

cdef extern from "realArrays.h":
	void chpl__init_realArrays(int64_t _ln, int32_t _fn);
	void takesArray(chpl_external_array * x);
	chpl_external_array returnsArray();
from chplrt cimport chpl_library_init, chpl_library_finalize, chpl_external_array, chpl_make_external_array, chpl_make_external_array_ptr, chpl_free_external_array
from chpl_realArrays cimport chpl__init_realArrays, takesArray as chpl_takesArray, returnsArray as chpl_returnsArray

import numpy
cimport numpy

def chpl_setup():
	cdef char** args = ['realArrays']
	chpl_library_init(1, args)
	chpl__init_realArrays(1, 1)

def chpl_cleanup():
	chpl_library_finalize()

def takesArray(x):
	cdef chpl_external_array chpl_x = chpl_make_external_array(sizeof(double), len(x))
	for i in range(len(x)):
		(<double*>chpl_x.elts)[i] = x[i]
	chpl_takesArray(&chpl_x)
	chpl_free_external_array(chpl_x)

def returnsArray():
	cdef chpl_external_array ret_arr = chpl_returnsArray()
	cdef numpy.ndarray [double, ndim=1] ret = numpy.zeros(shape = ret_arr.size, dtype = float)
	for i in range(ret_arr.size):
		ret[i] = (<double*>ret_arr.elts)[i]
	chpl_free_external_array(ret_arr)
	return ret
from distutils.core import setup
from distutils.core import Extension
from Cython.Build import cythonize
import numpy

setup(name = 'realArrays library',
	ext_modules = cythonize(
		Extension("realArrays",
			include_dirs=[numpy.get_include()],
			sources=["realArrays.pyx"],
			libraries=["realArrays"] + chpl_libraries)))
